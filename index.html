<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vida Kid - Control Maestro</title>
    <style>
        body { font-family: 'Times New Roman', Times, serif; background: #a98bee; margin: 0; padding: 10px; color: #000000; }
        .hidden { display: none; }
        header { text-align: center; margin-bottom: 15px; }
        .logo-container { width: 220px; height: 220px; background: white; border-radius: 50%; margin: 0 auto 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3); border: 6px solid white; }
        .logo-container img { width: 100%; height: 100%; object-fit: cover; }
        h1 { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); font-size: 1.8rem; margin: 5px 0; }
        .admin-monitor { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 5px solid #4f46e5; }
        .monitor-label { font-size: 0.75rem; color: #000; font-weight: bold; text-transform: uppercase; }
        .monitor-value { font-size: 1.4rem; color: #4f46e5; font-weight: bold; margin-left: 5px; }
        .table-container { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow-x: auto; color: #000; }
        .date-selector { padding: 8px; border-radius: 8px; border: 2px solid #4f46e5; font-weight: bold; font-family: 'Times New Roman', serif; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #e6e9ff; color: #000; font-size: 0.85rem; padding: 10px; border: 1px solid #ccc; }
        td { padding: 6px; border: 1px solid #eee; text-align: center; }
        .fila-extra { background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        .extra-grid { display: flex; flex-wrap: wrap; gap: 10px; padding: 8px; justify-content: center; }
        input[type="text"], input[type="number"], textarea { padding: 6px; border: 1px solid #999; border-radius: 5px; font-family: 'Times New Roman', serif; }
        .total-celda { font-weight: bold; color: #4f46e5; font-size: 1.1rem; }
        
        .footer-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; gap: 15px; }
        .btn { padding: 12px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Times New Roman', serif; transition: 0.3s; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .btn-save { background: #1a4293; color: white; }
        .btn-edit { background: #ff9800; color: white; }
        .btn-add { background: #4caf50; color: white; }
        
        input:read-only { background-color: #f1f1f1; border-color: transparent !important; color: #666; cursor: not-allowed; }
        input[type="checkbox"]:disabled { cursor: not-allowed; opacity: 0.8; }
        .btn-delete { display: none; background: #f44336; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; }
        .back { cursor: pointer; color: white; margin-bottom: 10px; display: inline-block; font-weight: bold; }
        .cards { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .card { background: white; padding: 25px; border-radius: 15px; cursor: pointer; min-width: 160px; text-align: center; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<section id="pagina-jornadas">
    <header>
        <div class="logo-container"><img src="vida kid.jpeg" alt="Logo"></div>
        <h1>CCVN</h1>
        <h3>Sigueme ( Mateo 9:9)</h3>
        <h2>Lista de Vida Kids</h2>
    </header>
    <div class="cards">
        <div class="card" onclick="irEdades('8:00 a 10:00')">Jornada 8:00 a 10:00</div>
        <div class="card" onclick="irEdades('11:00 a 13:00')">Jornada 11:00 a 13:00</div>
    </div>
</section>

<section id="pagina-edades" class="hidden">
    <div class="back" onclick="nav('pagina-edades','pagina-jornadas')">‚Üê Regresar</div>
    <h2 id="titulo-jornada" style="color: white; text-align: center;"></h2>
    <div class="cards">
        <div class="card" onclick="irTabla('3 a 5 a√±os')">Sal√≥n 3 a 5 a√±os</div>
        <div class="card" onclick="irTabla('6 a 9 a√±os')">Sal√≥n 6 a 9 a√±os</div>
    </div>
</section>

<section id="pagina-tabla" class="hidden">
    <div class="back" onclick="nav('pagina-tabla','pagina-edades')">‚Üê Regresar</div>
    <h2 id="titulo-clase" style="color: white; text-align: center;"></h2>
    
    <div class="admin-monitor">
        <div><span class="monitor-label">Fecha:</span> <input type="date" id="fechaClase" class="date-selector" onchange="window.cargarDatos()"></div>
        <div><span class="monitor-label">Ni√±os en Lista:</span> <span id="contadorAsistencia" class="monitor-value">0</span></div>
    </div>

    <div class="table-container">
        <div style="text-align: center; margin-bottom: 15px;">
            <label style="font-weight: bold;">PROFESORES:</label><br>
            <input type="text" id="inputProfesor" style="width: 80%; text-align: center; border:none; border-bottom: 2px solid #4f46e5; font-weight: bold; font-size: 1.1rem;" readonly>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Estudiante</th>
                    <th>Asistencia</th>
                    <th>Biblia</th>
                    <th>Cuaderno</th>
                    <th>Ofrenda</th>
                    <th>Vers√≠culo a memorizar</th>
                    <th>Coraz√≥n dispuesto</th>
                    <th>Puntos</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="tablaAlumnos"></tbody>
        </table>
        
        <div style="margin-top: 15px;">
            <label><b>Observaciones del d√≠a:</b></label>
            <textarea id="txtObservaciones" style="width: 95%; height: 60px; margin-top: 5px;"></textarea>
        </div>

        <div class="footer-controls">
            <button class="btn btn-save" onclick="guardar()">üíæ GUARDAR</button>
            <button id="btnModoEdicion" class="btn btn-edit" onclick="activarEdicion()">‚úèÔ∏è EDITAR NOMBRES</button>
            <button class="btn btn-add" onclick="nuevoEstudiante()">‚ûï NUEVO ESTUDIANTE</button>
        </div>
    </div>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "TU_API_KEY", 
        authDomain: "vida-kids-ca4b8.firebaseapp.com",
        projectId: "vida-kids-ca4b8",
        storageBucket: "vida-kids-ca4b8.firebasestorage.app",
        messagingSenderId: "287435029924",
        appId: "1:287435029924:web:0a92a25e151f6187089531"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const profesoresPorGrupo = {
        "8:00 a 10:00_3 a 5 a√±os": "Laura y Sarita",
        "8:00 a 10:00_6 a 9 a√±os": "Charles y Erika",
        "11:00 a 13:00_3 a 5 a√±os": "Mayerly y Martha",
        "11:00 a 13:00_6 a 9 a√±os": "Claudia"
    };

    let jornada = "", clase = "", modoEdicion = false;
    document.getElementById('fechaClase').valueAsDate = new Date();

    window.nav = (o, m) => {
        document.getElementById(o).classList.add('hidden');
        document.getElementById(m).classList.remove('hidden');
        bloquearTodo();
    };

    window.irEdades = (j) => { jornada = j; document.getElementById('titulo-jornada').innerText = "Jornada: " + j; nav('pagina-jornadas', 'pagina-edades'); };

    window.irTabla = (c) => {
        clase = c;
        const idClase = `${jornada}_${clase}`;
        document.getElementById('inputProfesor').value = profesoresPorGrupo[idClase] || "";
        document.getElementById('titulo-clase').innerText = `${clase} (${jornada})`;
        nav('pagina-edades', 'pagina-tabla');
        window.cargarDatos();
    };

    function bloquearTodo() {
        modoEdicion = false;
        document.querySelectorAll('.nombre, .acudiente, .tel').forEach(i => i.readOnly = true);
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.disabled = true);
        document.querySelectorAll('.btn-delete').forEach(b => b.style.display = "none");
        document.getElementById('btnModoEdicion').innerText = "‚úèÔ∏è CORREGIR NOMBRES";
        document.getElementById('btnModoEdicion').style.background = "#ff9800";
    }

    window.activarEdicion = () => {
        if (modoEdicion) { bloquearTodo(); return; }
        modoEdicion = true;
        document.querySelectorAll('.nombre, .acudiente, .tel').forEach(i => i.readOnly = false);
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.disabled = false);
        document.querySelectorAll('.btn-delete').forEach(b => b.style.display = "inline-block");
        document.getElementById('btnModoEdicion').innerText = "üîí BLOQUEAR EDICI√ìN";
        document.getElementById('btnModoEdicion').style.background = "#4f46e5";
    };

    window.nuevoEstudiante = () => {
        if (!modoEdicion) window.activarEdicion();
        agregarFila();
        // Nota: Ya no se llama a actualizarContador aqu√≠.
    };

    window.cargarDatos = async () => {
        const fecha = document.getElementById('fechaClase').value;
        const idClase = `${jornada}_${clase}`;
        const idFecha = `${fecha}_${jornada}_${clase}`;
        const [snapMaestra, snapFecha] = await Promise.all([getDoc(doc(db, "maestras", idClase)), getDoc(doc(db, "clases", idFecha))]);
        const listaBase = snapMaestra.exists() ? snapMaestra.data().alumnos : [];
        const dataFecha = snapFecha.exists() ? snapFecha.data() : { observaciones: "" };
        const tabla = document.getElementById('tablaAlumnos');
        tabla.innerHTML = "";
        listaBase.forEach(alumno => agregarFila(alumno));
        document.getElementById('txtObservaciones').value = dataFecha.observaciones || "";
        
        // Se cuenta al cargar para mostrar lo que ya est√° guardado en DB
        actualizarContador(); 
        bloquearTodo();
    };

    window.agregarFila = (d = {}) => {
        const tabla = document.getElementById('tablaAlumnos');
        const pts = d.puntos || [0,0,0,0,0]; 
        const totalPuntos = pts.reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
        const aut = d.autorizaciones || { fotos: false, video: false, redes: false, parque: false };
        const f1 = document.createElement('tr');
        f1.innerHTML = `
            <td>${Math.floor(tabla.rows.length/2) + 1}</td>
            <td><input type="text" class="nombre" value="${d.nombre || ''}" style="width:140px" readonly></td>
            <td><input type="number" class="asistencia-acumulada" value="${d.asistencia || 0}" style="width:40px"></td>
            ${pts.map(p => `<td><input type="number" class="punto" value="${p}" onchange="calc(this)" style="width:40px"></td>`).join('')}
            <td class="total-celda">${totalPuntos}</td>
            <td><button class="btn-delete" onclick="eliminarFila(this)">‚úï</button></td>
        `;
        const f2 = document.createElement('tr');
        f2.className = "fila-extra";
        f2.innerHTML = `<td colspan="10"><div class="extra-grid">
            <input type="text" class="acudiente" value="${d.acudiente || ''}" placeholder="Acudiente" style="width:130px" readonly>
            <input type="text" class="tel" value="${d.tel || ''}" placeholder="Tel" style="width:100px" readonly>
            <label><input type="checkbox" class="aut-foto" ${aut.fotos?'checked':''} disabled> Fotos üì∏</label>
            <label><input type="checkbox" class="aut-video" ${aut.video?'checked':''} disabled> Videos üé•</label>
            <label><input type="checkbox" class="aut-redes" ${aut.redes?'checked':''} disabled> Redes üåê</label>
            <label><input type="checkbox" class="aut-parque" ${aut.parque?'checked':''} disabled> Parque üå≥</label>
        </div></td>`;
        tabla.appendChild(f1); tabla.appendChild(f2);
        
        if (modoEdicion) {
            f1.querySelector('.nombre').readOnly = false;
            f2.querySelector('.acudiente').readOnly = false;
            f2.querySelector('.tel').readOnly = false;
            f2.querySelectorAll('input[type="checkbox"]').forEach(c => c.disabled = false);
            f1.querySelector('.btn-delete').style.display = "inline-block";
        }
        // Nota: Ya no se llama a actualizarContador aqu√≠.
    };

    window.eliminarFila = (btn) => { 
        if(confirm("¬øEliminar estudiante?")) { 
            btn.closest('tr').nextElementSibling.remove(); 
            btn.closest('tr').remove(); 
            // Nota: Ya no se llama a actualizarContador aqu√≠.
        } 
    };

    window.calc = (el) => {
        const row = el.closest('tr');
        const suma = Array.from(row.querySelectorAll('.punto')).reduce((a, p) => a + (parseInt(p.value) || 0), 0);
        row.querySelector('.total-celda').innerText = suma;
    };

    // Funci√≥n que actualiza el n√∫mero en el monitor azul
    function actualizarContador() { 
        document.getElementById('contadorAsistencia').innerText = document.querySelectorAll('#tablaAlumnos tr:nth-child(odd)').length; 
    }

    window.guardar = async () => {
        const fecha = document.getElementById('fechaClase').value;
        const idClase = `${jornada}_${clase}`;
        const idFecha = `${fecha}_${jornada}_${clase}`;
        const fPuntos = document.querySelectorAll('#tablaAlumnos tr:nth-child(odd)');
        const fExtra = document.querySelectorAll('#tablaAlumnos tr:nth-child(even)');
        const alumnosData = Array.from(fPuntos).map((r, i) => ({
            nombre: r.querySelector('.nombre').value,
            asistencia: parseInt(r.querySelector('.asistencia-acumulada').value) || 0,
            puntos: Array.from(r.querySelectorAll('.punto')).map(p => p.value),
            acudiente: fExtra[i].querySelector('.acudiente').value,
            tel: fExtra[i].querySelector('.tel').value,
            autorizaciones: {
                fotos: fExtra[i].querySelector('.aut-foto').checked,
                video: fExtra[i].querySelector('.aut-video').checked,
                redes: fExtra[i].querySelector('.aut-redes').checked,
                parque: fExtra[i].querySelector('.aut-parque').checked
            }
        }));

        await setDoc(doc(db, "maestras", idClase), { alumnos: alumnosData });
        await setDoc(doc(db, "clases", idFecha), { observaciones: document.getElementById('txtObservaciones').value, fecha });
        
        // El conteo se hace solo despu√©s de guardar exitosamente
        actualizarContador();
        
        alert("‚úÖ Informaci√≥n guardada con √©xito.");
        bloquearTodo();
    };
</script>
</body>
</html>