<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vida Kid - Control Maestro</title>
    <style>
        /* Estilo con Times New Roman y Color Negro para m√°xima claridad */
        body { 
            font-family: 'Times New Roman', Times, serif; 
            background: #a98bee; 
            margin: 0; 
            padding: 10px; 
            color: #000000; 
        }
        .hidden { display: none; }
        header { text-align: center; margin-bottom: 15px; }

        /* Logo Grande y Circular */
        .logo-container { 
            width: 220px; 
            height: 220px; 
            background: white; 
            border-radius: 50%; 
            margin: 0 auto 15px; 
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); 
            border: 6px solid white;
        }
        .logo-container img { width: 100%; height: 100%; object-fit: cover; }
        
        h1 { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); font-size: 1.8rem; margin: 5px 0; }
        
        .admin-monitor { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 5px solid #4f46e5; }
        .monitor-item { text-align: center; }
        .monitor-label { font-size: 0.75rem; color: #000; font-weight: bold; text-transform: uppercase; display: block; }
        .monitor-value { display: block; font-size: 1.4rem; color: #4f46e5; font-weight: bold; }
        
        .table-container { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow-x: auto; color: #000; }
        .date-selector { padding: 8px; border-radius: 8px; border: 2px solid #4f46e5; font-weight: bold; color: #000; font-size: 1rem; font-family: 'Times New Roman', serif; }

        table { width: 100%; border-collapse: collapse; min-width: 800px; color: #000; }
        th { background: #e6e9ff; color: #000; font-size: 0.85rem; padding: 10px; border: 1px solid #ccc; font-weight: bold; }
        td { padding: 6px; border: 1px solid #eee; text-align: center; }
        
        .fila-extra { background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        .extra-grid { display: flex; flex-wrap: wrap; gap: 10px; padding: 8px; justify-content: center; align-items: center; }
        .auth-item { display: flex; align-items: center; gap: 4px; font-size: 0.8rem; background: white; padding: 4px 8px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; color: #000; }
        
        input[type="text"], input[type="number"], textarea { padding: 6px; border: 1px solid #999; border-radius: 5px; font-size: 0.95rem; font-family: 'Times New Roman', serif; color: #000; }
        .total-celda { font-weight: bold; color: #4f46e5; font-size: 1.1rem; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; font-family: 'Times New Roman', serif; }
        .btn-save { background: #1a4293; color: white; width: 100%; margin-top: 15px; font-size: 1.1rem; }
        .btn-add { background: #4caf50; color: white; margin-top: 10px; }
        
        .back { cursor: pointer; color: white; margin-bottom: 10px; display: inline-block; font-weight: bold; font-size: 1.1rem; }
        .cards { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .card { background: white; padding: 25px; border-radius: 15px; cursor: pointer; min-width: 160px; text-align: center; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); color: #000; font-size: 1.1rem; }
    </style>
</head>
<body>

<section id="pagina-jornadas">
    <header>
        <div class="logo-container"><img src="vida kid.jpeg" alt="Logo"></div>
        <h1>Lista de Vida Kids</h1>
    </header>
    <div class="cards">
        <div class="card" onclick="irEdades('8:00 a 10:00')">Jornada 8:00 a 10:00</div>
        <div class="card" onclick="irEdades('11:00 a 13:00')">Jornada 11:00 a 13:00</div>
    </div>
</section>

<section id="pagina-edades" class="hidden">
    <div class="back" onclick="nav('pagina-edades','pagina-jornadas')">‚Üê Regresar</div>
    <h2 id="titulo-jornada" style="color: white; text-align: center;"></h2>
    <div class="cards">
        <div class="card" onclick="irTabla('3 a 5 a√±os')">Sal√≥n 3 a 5 a√±os</div>
        <div class="card" onclick="irTabla('6 a 9 a√±os')">Sal√≥n 6 a 9 a√±os</div>
    </div>
</section>

<section id="pagina-tabla" class="hidden">
    <div class="back" onclick="nav('pagina-tabla','pagina-edades')">‚Üê Regresar</div>
    <h2 id="titulo-clase" style="color: white; text-align: center;"></h2>
    
    <div class="admin-monitor">
        <div class="monitor-item">
            <span class="monitor-label">Fecha:</span>
            <input type="date" id="fechaClase" class="date-selector" onchange="window.escucharFecha()">
        </div>
        <div class="monitor-item">
            <span class="monitor-label">Ni√±os:</span>
            <span id="contadorAsistencia" class="monitor-value">0</span>
        </div>
    </div>

    <div class="table-container">
        <div style="text-align: center; margin-bottom: 10px;">
            <label style="font-size: 0.9rem; font-weight: bold;">PROFESORES:</label><br>
            <input type="text" id="inputProfesor" style="width: 80%; text-align: center; border:none; border-bottom: 2px solid #4f46e5; font-weight: bold; color: #000; font-size: 1.1rem;">
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Estudiante</th>
                    <th>Biblia</th>
                    <th>Cuaderno</th>
                    <th>Ofrenda</th>
                    <th>Vers√≠culo</th>
                    <th>Coraz√≥n dispuesto</th>
                    <th>Total</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="tablaAlumnos"></tbody>
        </table>
        
        <button class="btn btn-add" onclick="agregarFila()">‚ûï Nuevo Estudiante</button>
        
        <div style="margin-top: 15px;">
            <label style="font-size: 1rem;"><b>Observaciones:</b></label>
            <textarea id="txtObservaciones" style="width: 95%; height: 60px; margin-top: 5px;"></textarea>
        </div>

        <button class="btn btn-save" onclick="guardar()">üíæ GUARDAR INFORMACI√ìN</button>
    </div>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "TU_API_KEY", 
        authDomain: "vida-kids-ca4b8.firebaseapp.com",
        projectId: "vida-kids-ca4b8",
        storageBucket: "vida-kids-ca4b8.firebasestorage.app",
        messagingSenderId: "287435029924",
        appId: "1:287435029924:web:0a92a25e151f6187089531"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Corregido para coincidir exactamente con los botones
    const profesoresPorGrupo = {
        "8:00 a 10:00_3 a 5 a√±os": "Laura y Sarita",
        "8:00 a 10:00_6 a 9 a√±os": "Charles y Erika",
        "11:00 a 13:00_3 a 5 a√±os": "Mayerly y Martha",
        "11:00 a 13:00_6 a 9 a√±os": "Claudia"
    };

    let jornada = "", clase = "", unsubscribe = null;
    document.getElementById('fechaClase').valueAsDate = new Date();

    window.nav = (o, m) => {
        if (unsubscribe) unsubscribe();
        document.getElementById(o).classList.add('hidden');
        document.getElementById(m).classList.remove('hidden');
    };

    window.irEdades = (j) => {
        jornada = j;
        document.getElementById('titulo-jornada').innerText = "Jornada: " + j;
        nav('pagina-jornadas', 'pagina-edades');
    };

    window.irTabla = (c) => {
        clase = c;
        document.getElementById('titulo-clase').innerText = `${clase} (${jornada})`;
        const llave = `${jornada}_${clase}`;
        document.getElementById('inputProfesor').value = profesoresPorGrupo[llave] || "";
        nav('pagina-edades', 'pagina-tabla');
        window.escucharFecha();
    };

    window.escucharFecha = () => {
        const fecha = document.getElementById('fechaClase').value;
        const idDoc = `${fecha}_${jornada}_${clase}`;
        if (unsubscribe) unsubscribe();

        unsubscribe = onSnapshot(doc(db, "clases", idDoc), (snap) => {
            const tabla = document.getElementById('tablaAlumnos');
            tabla.innerHTML = "";
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('inputProfesor').value = data.profesor || "";
                document.getElementById('txtObservaciones').value = data.observaciones || "";
                if (data.alumnos) data.alumnos.forEach(n => agregarFila(n));
            } else {
                const llave = `${jornada}_${clase}`;
                document.getElementById('inputProfesor').value = profesoresPorGrupo[llave] || "";
                document.getElementById('txtObservaciones').value = "";
                agregarFila(); 
            }
            actualizarContador();
        });
    };

    window.agregarFila = (d = {}) => {
        const tabla = document.getElementById('tablaAlumnos');
        const pts = d.puntos || [0,0,0,0,0];
        const total = pts.reduce((a, b) => parseInt(a) + parseInt(b), 0);
        const aut = d.autorizaciones || { fotos: false, video: false, redes: false, parque: false };
        
        const f1 = document.createElement('tr');
        f1.innerHTML = `
            <td style="font-size:0.8rem">${Math.floor(tabla.rows.length/2) + 1}</td>
            <td><input type="text" class="nombre" value="${d.nombre || ''}" style="width:140px"></td>
            <td><input type="number" class="punto" value="${pts[0]}" onchange="calc(this)" style="width:40px"></td>
            <td><input type="number" class="punto" value="${pts[1]}" onchange="calc(this)" style="width:40px"></td>
            <td><input type="number" class="punto" value="${pts[2]}" onchange="calc(this)" style="width:40px"></td>
            <td><input type="number" class="punto" value="${pts[3]}" onchange="calc(this)" style="width:40px"></td>
            <td><input type="number" class="punto" value="${pts[4]}" onchange="calc(this)" style="width:40px"></td>
            <td class="total-celda">${total}</td>
            <td><button onclick="this.closest('tr').nextElementSibling.remove();this.closest('tr').remove();actualizarContador();">‚úï</button></td>
        `;
        
        const f2 = document.createElement('tr');
        f2.className = "fila-extra";
        f2.innerHTML = `
            <td colspan="9">
                <div class="extra-grid">
                    <input type="text" class="acudiente" value="${d.acudiente || ''}" placeholder="Acudiente" style="width:130px">
                    <input type="text" class="tel" value="${d.tel || ''}" placeholder="Tel" style="width:100px">
                    <label class="auth-item"><input type="checkbox" class="aut-foto" ${aut.fotos?'checked':''}>üì∏ Fotos</label>
                    <label class="auth-item"><input type="checkbox" class="aut-video" ${aut.video?'checked':''}>üé• Video</label>
                    <label class="auth-item"><input type="checkbox" class="aut-redes" ${aut.redes?'checked':''}>üåê Redes</label>
                    <label class="auth-item"><input type="checkbox" class="aut-parque" ${aut.parque?'checked':''}>üå≥ Parque</label>
                </div>
            </td>
        `;
        tabla.appendChild(f1);
        tabla.appendChild(f2);
        actualizarContador();
    };

    window.calc = (el) => {
        const row = el.closest('tr');
        const pts = Array.from(row.querySelectorAll('.punto')).map(p => parseInt(p.value) || 0);
        row.querySelector('.total-celda').innerText = pts.reduce((a,b) => a+b, 0);
    };

    function actualizarContador() {
        const total = document.querySelectorAll('#tablaAlumnos tr:nth-child(odd)').length;
        document.getElementById('contadorAsistencia').innerText = total;
    }

    window.guardar = async () => {
        const fecha = document.getElementById('fechaClase').value;
        const idDoc = `${fecha}_${jornada}_${clase}`;
        const fPuntos = document.querySelectorAll('#tablaAlumnos tr:nth-child(odd)');
        const fExtra = document.querySelectorAll('#tablaAlumnos tr:nth-child(even)');
        
        const alumnos = Array.from(fPuntos).map((r, i) => ({
            nombre: r.querySelector('.nombre').value,
            puntos: Array.from(r.querySelectorAll('.punto')).map(p => p.value),
            acudiente: fExtra[i].querySelector('.acudiente').value,
            tel: fExtra[i].querySelector('.tel').value,
            autorizaciones: {
                fotos: fExtra[i].querySelector('.aut-foto').checked,
                video: fExtra[i].querySelector('.aut-video').checked,
                redes: fExtra[i].querySelector('.aut-redes').checked,
                parque: fExtra[i].querySelector('.aut-parque').checked
            }
        }));

        await setDoc(doc(db, "clases", idDoc), {
            profesor: document.getElementById('inputProfesor').value,
            observaciones: document.getElementById('txtObservaciones').value,
            alumnos,
            fecha
        });
        alert("‚úÖ ¬°Informaci√≥n guardada!");
    };
</script>
</body>
</html>