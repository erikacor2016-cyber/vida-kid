<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vida Kid - Control Maestro</title>
    <style>
        /* ESTRUCTURA Y FONDO */
        body { font-family: 'Times New Roman', Times, serif; background: #a98bee; margin: 0; padding: 10px; color: #000000; }
        .hidden { display: none; }
        header { text-align: center; margin-bottom: 15px; }
        
        .logo-container { width: 220px; height: 220px; background: white; border-radius: 50%; margin: 0 auto 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3); border: 6px solid white; }
        .logo-container img { width: 100%; height: 100%; object-fit: cover; }
        h1 { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); font-size: 1.8rem; margin: 5px 0; }
        
        /* SEM√ÅFORO Y ALERTAS */
        .semaforo { width: 18px; height: 18px; border-radius: 50%; display: inline-block; vertical-align: middle; margin-right: 8px; border: 1px solid #999; cursor: pointer; }
        .fallas-ok { background: #e0e0e0; }
        .fallas-3 { background: #ffeb3b; box-shadow: 0 0 8px #fbc02d; }
        .fallas-6 { background: #f44336; box-shadow: 0 0 8px #d32f2f; }
        .msg-alerta { display: block; font-size: 0.65rem; color: #666; font-weight: bold; margin-top: 3px; line-height: 1.1; }

        .admin-monitor { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 5px solid #4f46e5; }
        .monitor-label { font-size: 0.75rem; color: #000; font-weight: bold; text-transform: uppercase; }
        .monitor-value { font-size: 1.4rem; color: #473fdb; font-weight: bold; margin-left: 5px; }
        
        .table-container { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow-x: auto; color: #000; }
        .date-selector { padding: 8px; border-radius: 8px; border: 2px solid #4f46e5; font-weight: bold; font-family: 'Times New Roman', serif; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #e6e9ff; color: #000; font-size: 0.85rem; padding: 10px; border: 1px solid #ccc; }
        td { padding: 8px; border: 1px solid #eee; text-align: center; }
        .fila-extra { background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        .extra-grid { display: flex; flex-wrap: wrap; gap: 10px; padding: 8px; justify-content: center; align-items: center; }

        input[type="text"], input[type="number"], input[type="date"], textarea { padding: 6px; border: 1px solid #999; border-radius: 5px; font-family: 'Times New Roman', serif; }
        .total-celda { font-weight: bold; color: #4c81f5; font-size: 1.1rem; }
        input:read-only, input[type="checkbox"]:disabled { background-color: #f9f9f9; border-color: transparent !important; color: #555; cursor: not-allowed; }
        
        .btn-contacto { text-decoration: none; font-size: 1.2rem; margin-left: 5px; }
        .botones-control { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Times New Roman', serif; transition: 0.3s; flex: 1; text-align: center; color: #2c3e50; }
        .btn-add { background: #9af09d; }
        .btn-edit { background: #d19ef5; }
        .btn-save { background: #51e5f0; font-size: 1rem; }
        .btn:hover { filter: brightness(0.9); }
        .btn-delete { display: none; background: #f44336; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; }

        .back { cursor: pointer; color: white; margin-bottom: 10px; display: inline-block; font-weight: bold; }
        .cards { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .card { background: white; padding: 25px; border-radius: 15px; cursor: pointer; min-width: 160px; text-align: center; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .asistencia-acumulada { background-color: #e8f5e9; border: 2px solid #2e7d32 !important; font-weight: bold; }
        .input-label-small { font-size: 0.7rem; font-weight: bold; display: block; margin-bottom: 2px; }

        #contenedor-cumpleanos { margin-bottom: 15px; display: none; }
        .alerta-cumple { background: #fff3cd; border: 2px dashed #ff9800; border-radius: 12px; padding: 12px; color: #856404; }
    </style>
</head>
<body>

<section id="pagina-jornadas">
    <header>
        <div class="logo-container"><img src="vida kids.jpeg" alt="Logo"></div>
        <h1>CCVN</h1>
        <h3>Sugieme ( Mateo 9:9)</h3>
        <h2>Lista de Vida Kids</h2>
    </header>
    <div class="cards">
        <div class="card" onclick="irEdades('8:00 a 10:00')">Jornada 8:00 a 10:00</div>
        <div class="card" onclick="irEdades('11:00 a 13:00')">Jornada 11:00 a 13:00</div>
    </div>
</section>

<section id="pagina-edades" class="hidden">
    <div class="back" onclick="nav('pagina-edades','pagina-jornadas')">‚Üê Regresar</div>
    <h2 id="titulo-jornada" style="color: white; text-align: center;"></h2>
    <div class="cards">
        <div class="card" onclick="irTabla('3 a 5 a√±os')">Sal√≥n 3 a 5 a√±os</div>
        <div class="card" onclick="irTabla('6 a 9 a√±os')">Sal√≥n 6 a 9 a√±os</div>
    </div>
</section>

<section id="pagina-tabla" class="hidden">
    <div class="back" onclick="nav('pagina-tabla','pagina-edades')">‚Üê Regresar</div>
    <h2 id="titulo-clase" style="color: white; text-align: center;"></h2>
    
    <div class="admin-monitor">
        <div>
            <span class="monitor-label">Fecha:</span>
            <input type="date" id="fechaClase" class="date-selector" onchange="window.cargarDatos()">
        </div>
        <div>
            <span class="monitor-label">En Lista:</span>
            <span id="contadorAsistencia" class="monitor-value">0</span>
        </div>
    </div>

    <div id="contenedor-cumpleanos">
        <div class="alerta-cumple">
            <h4 style="margin: 0 0 5px 0;">üéâ Avisos de Cumplea√±os:</h4>
            <ul id="lista-cumples" style="margin: 0; padding-left: 20px;"></ul>
        </div>
    </div>

    <div class="table-container">
        <div style="text-align: center; margin-bottom: 15px;">
            <label style="font-weight: bold;">PROFESORES:</label><br>
            <input type="text" id="inputProfesor" style="width: 80%; text-align: center; border:none; border-bottom: 2px solid #4f46e5; font-weight: bold; font-size: 1.1rem;" readonly>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Estudiante</th>
                    <th>Asistencia</th>
                    <th>Biblia</th>
                    <th>Cuaderno</th>
                    <th>Ofrenda</th>
                    <th>Vers√≠culo a memorizar</th>
                    <th>Coraz√≥n dispuesto</th>
                    <th>Total</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="tablaAlumnos"></tbody>
        </table>
        
        <div style="margin-top: 15px;">
            <label><b>Observaciones de la fecha:</b></label>
            <textarea id="txtObservaciones" style="width: 98%; height: 50px; margin-top: 5px;"></textarea>
        </div>

        <div class="botones-control">
            <button class="btn btn-add" onclick="agregarFila({}, true)">‚ûï Nuevo Estudiante</button>
            <button id="btnModoEdicion" class="btn btn-edit" onclick="toggleEdicion()">üîì Editar Datos</button>
            <button class="btn btn-save" onclick="guardar()">üíæ Guardar</button>
        </div>
    </div>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "TU_API_KEY", 
        authDomain: "vida-kids-ca4b8.firebaseapp.com",
        projectId: "vida-kids-ca4b8",
        storageBucket: "vida-kids-ca4b8.firebasestorage.app",
        messagingSenderId: "287435029924",
        appId: "1:287435029924:web:0a92a25e151f6187089531"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const profesoresPorGrupo = {
        "8:00 a 10:00_3 a 5 a√±os": "Laura y Sarita",
        "8:00 a 10:00_6 a 9 a√±os": "Charles y Erika",
        "11:00 a 13:00_3 a 5 a√±os": "Mayerly y Martha",
        "11:00 a 13:00_6 a 9 a√±os": "Claudia"
    };

    let jornada = "", clase = "", modoEdicion = false;
    
    const hoyLocal = new Date();
    document.getElementById('fechaClase').value = hoyLocal.toISOString().split('T')[0];

    window.nav = (o, m) => {
        document.getElementById(o).classList.add('hidden');
        document.getElementById(m).classList.remove('hidden');
        if (m === 'pagina-jornadas' || m === 'pagina-edades') { modoEdicion = false; }
    };

    window.irEdades = (j) => {
        jornada = j;
        document.getElementById('titulo-jornada').innerText = "Jornada: " + j;
        nav('pagina-jornadas', 'pagina-edades');
    };

    window.irTabla = (c) => {
        clase = c;
        const idClase = `${jornada}_${clase}`;
        document.getElementById('inputProfesor').value = profesoresPorGrupo[idClase] || "";
        document.getElementById('titulo-clase').innerText = `${clase} (${jornada})`;
        nav('pagina-edades', 'pagina-tabla');
        window.cargarDatos();
    };

    window.toggleEdicion = () => {
        modoEdicion = !modoEdicion;
        const btn = document.getElementById('btnModoEdicion');
        const inputs = document.querySelectorAll('.nombre, .acudiente, .tel, .cumple');
        const checks = document.querySelectorAll('.aut-foto, .aut-video, .aut-redes, .aut-parque');
        const deletes = document.querySelectorAll('.btn-delete');

        btn.innerText = modoEdicion ? "üîí Bloquear Datos" : "üîì Editar Datos";
        btn.style.background = modoEdicion ? "#4f46e5" : "#d19ef5";
        inputs.forEach(i => i.readOnly = !modoEdicion);
        checks.forEach(c => c.disabled = !modoEdicion);
        deletes.forEach(b => b.style.display = modoEdicion ? "inline-block" : "none");
    };

    window.cargarDatos = async () => {
        const idClase = `${jornada}_${clase}`;
        const snapMaestra = await getDoc(doc(db, "maestras", idClase));
        const listaBase = snapMaestra.exists() ? snapMaestra.data().alumnos : [];
        const tabla = document.getElementById('tablaAlumnos');
        tabla.innerHTML = "";
        listaBase.forEach(alumno => agregarFila(alumno, false));
        actualizarContador();
        window.verificarCumpleanos();
        modoEdicion = true; window.toggleEdicion();
    };

    window.calcularEdad = (fechaNacimiento) => {
        if (!fechaNacimiento) return "";
        const hoy = new Date();
        const cumple = new Date(fechaNacimiento + "T00:00:00");
        let edad = hoy.getFullYear() - cumple.getFullYear();
        const m = hoy.getMonth() - cumple.getMonth();
        if (m < 0 || (m === 0 && hoy.getDate() < cumple.getDate())) { edad--; }
        return edad;
    };

    window.actualizarEdadFila = (el) => {
        const filaExtra = el.closest('.fila-extra');
        const edadInput = filaExtra.querySelector('.edad');
        edadInput.value = window.calcularEdad(el.value);
    };

    window.gestionarFallas = (nombre, el) => {
        const menu = "Elija el motivo para resetear sem√°foro:\n1. Enfermo\n2. De viaje\n3. Cambio de iglesia\n4. No quiere subir";
        const r = prompt(`Gesti√≥n para ${nombre}\n${menu}`);
        if (r) {
            el.className = "semaforo fallas-ok";
            el.dataset.fallas = 0;
            const msg = el.parentElement.querySelector('.msg-alerta');
            if (msg) msg.remove();
            alert("Motivo registrado. El sem√°foro se reiniciar√° al guardar.");
        }
    };

    window.agregarFila = (d = {}, esNuevo = false) => {
        const tabla = document.getElementById('tablaAlumnos');
        const pts = d.puntos || [0,0,0,0,0]; 
        const totalPuntos = pts.reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
        const fallas = d.fallas || 0;
        
        // Ajuste para permitir escribir en estudiantes nuevos
        const isReadOnly = (modoEdicion || esNuevo) ? "" : "readonly";
        const isDisabled = (modoEdicion || esNuevo) ? "" : "disabled";
        
        let claseSem = "fallas-ok";
        let msg = "";
        if (fallas >= 3 && fallas < 6) {
            claseSem = "fallas-3";
            msg = `<span class="msg-alerta">Hola profe, ${d.nombre || ''} no ha venido. Ser√≠a bueno llamarlo.</span>`;
        } else if (fallas >= 6) {
            claseSem = "fallas-6";
            msg = `<span class="msg-alerta">Ojo profe, recuerda que es importante llamar a ${d.nombre || ''}.</span>`;
        }

        const f1 = document.createElement('tr');
        f1.innerHTML = `
            <td>${Math.floor(tabla.rows.length/2) + 1}</td>
            <td style="text-align: left;">
                <div class="semaforo ${claseSem}" data-fallas="${fallas}" onclick="gestionarFallas('${d.nombre}', this)"></div>
                <input type="text" class="nombre" value="${d.nombre || ''}" style="width:130px" ${isReadOnly}>
                ${msg}
            </td>
            <td><input type="number" class="asistencia-acumulada" value="${d.asistencia || 0}" style="width:40px"></td>
            ${pts.map(p => `<td><input type="number" class="punto" value="${p}" onchange="calc(this)" style="width:35px"></td>`).join('')}
            <td class="total-celda">${totalPuntos}</td>
            <td><button class="btn-delete" style="${esNuevo ? 'display:inline-block' : ''}" onclick="eliminarFila(this)">‚úï</button></td>
        `;
        
        const f2 = document.createElement('tr');
        f2.className = "fila-extra";
        f2.innerHTML = `<td colspan="10"><div class="extra-grid">
            <div><span class="input-label-small">Edad</span><input type="number" class="edad" value="${window.calcularEdad(d.cumple) || ''}" style="width:45px" readonly></div>
            <div><span class="input-label-small">Cumple</span><input type="date" class="cumple" value="${d.cumple || ''}" style="width:115px" onchange="actualizarEdadFila(this)" ${isReadOnly}></div>
            <div><span class="input-label-small">Acudiente</span><input type="text" class="acudiente" value="${d.acudiente || ''}" style="width:100px" ${isReadOnly}></div>
            <div><span class="input-label-small">Tel√©fono</span><input type="text" class="tel" value="${d.tel || ''}" style="width:85px" ${isReadOnly}>
                <a href="tel:${d.tel}" class="btn-contacto">üìû</a><a href="https://wa.me/57${d.tel}" target="_blank" class="btn-contacto">üü¢</a>
            </div>
            <label><input type="checkbox" class="aut-foto" ${d.autorizaciones?.fotos?'checked':''} ${isDisabled}> Fotos üì∏</label>
            <label><input type="checkbox" class="aut-video" ${d.autorizaciones?.video?'checked':''} ${isDisabled}> Videos üé•</label>
            <label><input type="checkbox" class="aut-redes" ${d.autorizaciones?.redes?'checked':''} ${isDisabled}> Redes sociales üåê</label>
            <label><input type="checkbox" class="aut-parque" ${d.autorizaciones?.parque?'checked':''} ${isDisabled}>  Parque üå≥</label>
        </div></td>`;

        tabla.appendChild(f1);
        tabla.appendChild(f2);
        if(esNuevo) actualizarContador();
    };

    window.eliminarFila = (btn) => {
        if(confirm("¬øEliminar estudiante?")) {
            btn.closest('tr').nextElementSibling.remove();
            btn.closest('tr').remove();
            actualizarContador();
        }
    };

    window.calc = (el) => {
        const row = el.closest('tr');
        const suma = Array.from(row.querySelectorAll('.punto')).reduce((a, p) => a + (parseInt(p.value) || 0), 0);
        row.querySelector('.total-celda').innerText = suma;
    };

    function actualizarContador() {
        document.getElementById('contadorAsistencia').innerText = document.querySelectorAll('#tablaAlumnos tr:nth-child(odd)').length;
    }

    window.verificarCumpleanos = () => {
        const fSel = new Date(document.getElementById('fechaClase').value + "T00:00:00");
        const nombres = document.querySelectorAll('.nombre');
        const cumples = document.querySelectorAll('.cumple');
        const listaUI = document.getElementById('lista-cumples');
        listaUI.innerHTML = "";
        let hay = false;

        nombres.forEach((n, i) => {
            if (n.value && cumples[i].value) {
                const nac = new Date(cumples[i].value + "T00:00:00");
                if (fSel.getDate() === nac.getDate() && fSel.getMonth() === nac.getMonth()) {
                    const li = document.createElement('li'); li.innerText = `üéÇ ¬°HOY es el cumple de ${n.value}!`;
                    listaUI.appendChild(li); hay = true;
                }
            }
        });
        document.getElementById('contenedor-cumpleanos').style.display = hay ? 'block' : 'none';
    };

    window.guardar = async () => {
        const idClase = `${jornada}_${clase}`;
        const fPuntos = document.querySelectorAll('#tablaAlumnos tr:nth-child(odd)');
        const fExtra = document.querySelectorAll('#tablaAlumnos tr:nth-child(even)');
        
        const alumnosData = Array.from(fPuntos).map((r, i) => {
            const ptsHoy = parseInt(r.querySelector('.total-celda').innerText);
            let fallasActuales = parseInt(r.querySelector('.semaforo').dataset.fallas) || 0;
            if (ptsHoy === 0) fallasActuales++; else fallasActuales = 0;

            return {
                nombre: r.querySelector('.nombre').value,
                asistencia: parseInt(r.querySelector('.asistencia-acumulada').value) || 0,
                fallas: fallasActuales,
                puntos: Array.from(r.querySelectorAll('.punto')).map(p => p.value),
                cumple: fExtra[i].querySelector('.cumple').value,
                edad: fExtra[i].querySelector('.edad').value,
                acudiente: fExtra[i].querySelector('.acudiente').value,
                tel: fExtra[i].querySelector('.tel').value,
                autorizaciones: {
                    fotos: fExtra[i].querySelector('.aut-foto').checked,
                    video: fExtra[i].querySelector('.aut-video').checked,
                    redes: fExtra[i].querySelector('.aut-redes').checked,
                    parque: fExtra[i].querySelector('.aut-parque').checked
                }
            };
        });

        await setDoc(doc(db, "maestras", idClase), { alumnos: alumnosData });
        alert("‚úÖ Guardado con √©xito. Las fallas han sido actualizadas.");
        window.cargarDatos(); 
    };
</script>
</body>
</html>