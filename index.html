<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vida Kid - Control Maestro</title>
    <style>
        body { font-family: 'Times New Roman', Times, serif; background: #a98bee; margin: 0; padding: 10px; color: #000000; }
        .hidden { display: none; }
        header { text-align: center; margin-bottom: 15px; }
        .logo-container { width: 220px; height: 220px; background: white; border-radius: 50%; margin: 0 auto 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3); border: 6px solid white; }
        .logo-container img { width: 100%; height: 100%; object-fit: cover; }
        h1 { color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); font-size: 1.8rem; margin: 5px 0; }
        .admin-monitor { background: #fff; padding: 12px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 5px solid #4f46e5; }
        .monitor-label { font-size: 0.75rem; color: #000; font-weight: bold; text-transform: uppercase; }
        .monitor-value { font-size: 1.4rem; color: #4f46e5; font-weight: bold; margin-left: 5px; }
        .table-container { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow-x: auto; color: #000; }
        .date-selector { padding: 8px; border-radius: 8px; border: 2px solid #4f46e5; font-weight: bold; font-family: 'Times New Roman', serif; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #e6e9ff; color: #000; font-size: 0.85rem; padding: 10px; border: 1px solid #ccc; }
        td { padding: 6px; border: 1px solid #eee; text-align: center; }
        .fila-extra { background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        .extra-grid { display: flex; flex-wrap: wrap; gap: 10px; padding: 8px; justify-content: center; }
        input[type="text"], input[type="number"], textarea { padding: 6px; border: 1px solid #999; border-radius: 5px; font-family: 'Times New Roman', serif; }
        .total-celda { font-weight: bold; color: #4f46e5; font-size: 1.1rem; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Times New Roman', serif; }
        .btn-save { background: #1a4293; color: white; width: 100%; margin-top: 15px; }
        .btn-add { background: #4caf50; color: white; margin-top: 10px; }
        .back { cursor: pointer; color: white; margin-bottom: 10px; display: inline-block; font-weight: bold; }
        .cards { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .card { background: white; padding: 25px; border-radius: 15px; cursor: pointer; min-width: 160px; text-align: center; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        /* Resaltamos la asistencia para que sepa que es acumulativa */
        .asistencia-acumulada { background-color: #e8f5e9; border: 2px solid #2e7d32 !important; font-weight: bold; color: #2e7d32; }
    </style>
</head>
<body>

<section id="pagina-jornadas">
    <header>
        <div class="logo-container"><img src="vida kid.jpeg" alt="Logo"></div>
        <h1>Lista de Vida Kids</h1>
    </header>
    <div class="cards">
        <div class="card" onclick="irEdades('8:00 a 10:00')">Jornada 8:00 a 10:00</div>
        <div class="card" onclick="irEdades('11:00 a 13:00')">Jornada 11:00 a 13:00</div>
    </div>
</section>

<section id="pagina-edades" class="hidden">
    <div class="back" onclick="nav('pagina-edades','pagina-jornadas')">‚Üê Regresar</div>
    <h2 id="titulo-jornada" style="color: white; text-align: center;"></h2>
    <div class="cards">
        <div class="card" onclick="irTabla('3 a 5 a√±os')">Sal√≥n 3 a 5 a√±os</div>
        <div class="card" onclick="irTabla('6 a 9 a√±os')">Sal√≥n 6 a 9 a√±os</div>
    </div>
</section>

<section id="pagina-tabla" class="hidden">
    <div class="back" onclick="nav('pagina-tabla','pagina-edades')">‚Üê Regresar</div>
    <h2 id="titulo-clase" style="color: white; text-align: center;"></h2>
    
    <div class="admin-monitor">
        <div>
            <span class="monitor-label">Fecha:</span>
            <input type="date" id="fechaClase" class="date-selector" onchange="window.cargarDatos()">
        </div>
        <div>
            <span class="monitor-label">Ni√±os en Lista:</span>
            <span id="contadorAsistencia" class="monitor-value">0</span>
        </div>
    </div>

    <div class="table-container">
        <div style="text-align: center; margin-bottom: 10px;">
            <label style="font-weight: bold;">PROFESORES:</label><br>
            <input type="text" id="inputProfesor" style="width: 80%; text-align: center; border:none; border-bottom: 2px solid #4f46e5; font-weight: bold; font-size: 1.1rem;" readonly>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Estudiante</th>
                    <th>Asistencias</th>
                    <th>Biblia</th>
                    <th>Cuaderno</th>
                    <th>Ofrenda</th>
                    <th>Vers√≠culo a memorizar</th>
                    <th>Coraz√≥n duspuesto</th>
                    <th>Puntos Totales</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody id="tablaAlumnos"></tbody>
        </table>
        
        <button class="btn btn-add" onclick="agregarFila()">‚ûï Nuevo Estudiante</button>
        
        <div style="margin-top: 15px;">
            <label><b>Observaciones del d√≠a:</b></label>
            <textarea id="txtObservaciones" style="width: 95%; height: 60px; margin-top: 5px;"></textarea>
        </div>

        <button class="btn btn-save" onclick="guardar()">üíæ GUARDAR</button>
    </div>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "TU_API_KEY", 
        authDomain: "vida-kids-ca4b8.firebaseapp.com",
        projectId: "vida-kids-ca4b8",
        storageBucket: "vida-kids-ca4b8.firebasestorage.app",
        messagingSenderId: "287435029924",
        appId: "1:287435029924:web:0a92a25e151f6187089531"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const profesoresPorGrupo = {
        "8:00 a 10:00_3 a 5 a√±os": "Laura y Sarita",
        "8:00 a 10:00_6 a 9 a√±os": "Charles y Erika",
        "11:00 a 13:00_3 a 5 a√±os": "Mayerly y Martha",
        "11:00 a 13:00_6 a 9 a√±os": "Claudia"
    };

    let jornada = "", clase = "";
    document.getElementById('fechaClase').valueAsDate = new Date();

    window.nav = (o, m) => {
        document.getElementById(o).classList.add('hidden');
        document.getElementById(m).classList.remove('hidden');
    };

    window.irEdades = (j) => {
        jornada = j;
        document.getElementById('titulo-jornada').innerText = "Jornada: " + j;
        nav('pagina-jornadas', 'pagina-edades');
    };

    window.irTabla = (c) => {
        clase = c;
        const idClase = `${jornada}_${clase}`;
        document.getElementById('inputProfesor').value = profesoresPorGrupo[idClase] || "";
        document.getElementById('titulo-clase').innerText = `${clase} (${jornada})`;
        nav('pagina-edades', 'pagina-tabla');
        window.cargarDatos();
    };

    window.cargarDatos = async () => {
        const fecha = document.getElementById('fechaClase').value;
        const idClase = `${jornada}_${clase}`;
        const idFecha = `${fecha}_${jornada}_${clase}`;

        // Todo se carga de "maestras" para que sea permanente (puntos y asistencias)
        const [snapMaestra, snapFecha] = await Promise.all([
            getDoc(doc(db, "maestras", idClase)),
            getDoc(doc(db, "clases", idFecha))
        ]);

        const listaBase = snapMaestra.exists() ? snapMaestra.data().alumnos : [];
        const dataFecha = snapFecha.exists() ? snapFecha.data() : { observaciones: "" };

        const tabla = document.getElementById('tablaAlumnos');
        tabla.innerHTML = "";

        listaBase.forEach(alumno => {
            agregarFila(alumno);
        });

        document.getElementById('txtObservaciones').value = dataFecha.observaciones || "";
        actualizarContador();
    };

    window.agregarFila = (d = {}) => {
        const tabla = document.getElementById('tablaAlumnos');
        // pts: casillas de Biblia hasta Coraz√≥n
        const pts = d.puntos || [0,0,0,0,0]; 
        const totalPuntos = pts.reduce((a, b) => parseInt(a || 0) + parseInt(b || 0), 0);
        const aut = d.autorizaciones || { fotos: false, video: false, redes: false, parque: false };
        
        const f1 = document.createElement('tr');
        f1.innerHTML = `
            <td>${Math.floor(tabla.rows.length/2) + 1}</td>
            <td><input type="text" class="nombre" value="${d.nombre || ''}" style="width:140px"></td>
            <td><input type="number" class="asistencia-acumulada" value="${d.asistencia || 0}" style="width:40px"></td>
            <td><input type="number" class="punto" value="${pts[0]}" onchange="calc(this)" style="width:40px"></td>
            <td><input type="number" class="punto" value="${pts[1]}" onchange="calc(this)" style="width:40px"></td>
            <td><input type="number" class="punto" value="${pts[2]}" onchange="calc(this)" style="width:40px"></td>
            <td><input type="number" class="punto" value="${pts[3]}" onchange="calc(this)" style="width:40px"></td>
            <td><input type="number" class="punto" value="${pts[4]}" onchange="calc(this)" style="width:40px"></td>
            <td class="total-celda">${totalPuntos}</td>
            <td><button onclick="eliminarFila(this)">‚úï</button></td>
        `;
        
        const f2 = document.createElement('tr');
        f2.className = "fila-extra";
        f2.innerHTML = `<td colspan="10"><div class="extra-grid">
            <input type="text" class="acudiente" value="${d.acudiente || ''}" placeholder="Acudiente" style="width:130px">
            <input type="text" class="tel" value="${d.tel || ''}" placeholder="Tel" style="width:100px">
            <label><input type="checkbox" class="aut-foto" ${aut.fotos?'checked':''}> Fotos üì∏</label>
            <label><input type="checkbox" class="aut-video" ${aut.video?'checked':''}> Videos üé•</label>
            <label><input type="checkbox" class="aut-redes" ${aut.redes?'checked':''}> Subirlo a las üåê</label>
            <label><input type="checkbox" class="aut-parque" ${aut.parque?'checked':''}> Salir al parque üå≥</label>
        </div></td>`;

        tabla.appendChild(f1);
        tabla.appendChild(f2);
        actualizarContador();
    };

    window.eliminarFila = (btn) => {
        if(confirm("¬øEliminar definitivamente?")) {
            btn.closest('tr').nextElementSibling.remove();
            btn.closest('tr').remove();
            actualizarContador();
        }
    };

    window.calc = (el) => {
        const row = el.closest('tr');
        const inputsPuntos = Array.from(row.querySelectorAll('.punto'));
        const suma = inputsPuntos.reduce((a, p) => a + (parseInt(p.value) || 0), 0);
        row.querySelector('.total-celda').innerText = suma;
    };

    function actualizarContador() {
        document.getElementById('contadorAsistencia').innerText = document.querySelectorAll('#tablaAlumnos tr:nth-child(odd)').length;
    }

    window.guardar = async () => {
        const fecha = document.getElementById('fechaClase').value;
        const idClase = `${jornada}_${clase}`;
        const idFecha = `${fecha}_${jornada}_${clase}`;
        
        const fPuntos = document.querySelectorAll('#tablaAlumnos tr:nth-child(odd)');
        const fExtra = document.querySelectorAll('#tablaAlumnos tr:nth-child(even)');
        
        const alumnosData = Array.from(fPuntos).map((r, i) => ({
            nombre: r.querySelector('.nombre').value,
            asistencia: parseInt(r.querySelector('.asistencia-acumulada').value) || 0,
            puntos: Array.from(r.querySelectorAll('.punto')).map(p => p.value),
            acudiente: fExtra[i].querySelector('.acudiente').value,
            tel: fExtra[i].querySelector('.tel').value,
            autorizaciones: {
                fotos: fExtra[i].querySelector('.aut-foto').checked,
                video: fExtra[i].querySelector('.aut-video').checked,
                redes: fExtra[i].querySelector('.aut-redes').checked,
                parque: fExtra[i].querySelector('.aut-parque').checked
            }
        }));

        // Guardamos todo en la MAESTRA para que sea permanente
        await setDoc(doc(db, "maestras", idClase), { alumnos: alumnosData });
        
        // Guardamos las observaciones del d√≠a por separado
        await setDoc(doc(db, "clases", idFecha), {
            observaciones: document.getElementById('txtObservaciones').value,
            fecha
        });

        alert("‚úÖ Datos actualizados. La asistencia y los puntos se han sumado correctamente.");
    };
</script>
</body>
</html>